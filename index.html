<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PangChat Room</title>
<style>
body { background:#111; color:white; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; padding:20px;}
#chatContainer { width:90%; max-width:600px; height:400px; overflow-y:auto; background:#222; padding:10px; border-radius:10px; margin-bottom:10px;}
.message { margin:5px 0; padding:5px; border-radius:5px; background:#444; }
.message p { margin:2px 0 0 0; }
.message a { color:#0af; text-decoration:underline; }
#inputRow { display:flex; width:90%; max-width:600px; }
#nameInput, #textInput { padding:8px; border-radius:5px; border:none; margin-right:5px; flex:1; }
#sendBtn { padding:8px 15px; border:none; border-radius:5px; background:#00f; color:#fff; cursor:pointer; }
.dev-delete { font-size:10px; color:red; cursor:pointer; margin-left:6px; }
</style>
</head>
<body>

<h2>PangChat Room</h2>
<div id="chatContainer"></div>

<div id="inputRow">
<input id="nameInput" placeholder="Your name" />
<input id="textInput" placeholder="Type a message..." />
<button id="sendBtn">Send</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBpDQlmOZHQrdRQF1mQPk_aPgxwb6gbheY",
  authDomain: "pangai.firebaseapp.com",
  projectId: "pangai",
  storageBucket: "pangai.firebasestorage.app",
  messagingSenderId: "456349287523",
  appId: "1:456349287523:web:e0a252e4b55f3dd294e456"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const chatContainer = document.getElementById('chatContainer');
const nameInput = document.getElementById('nameInput');
const textInput = document.getElementById('textInput');
const sendBtn = document.getElementById('sendBtn');

// Markdown parser
function parseMarkdown(text){
    text = text.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
    text = text.replace(/\*(.*?)\*/g, "<i>$1</i>");
    text = text.replace(/`(.*?)`/g, "<code>$1</code>");
    text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
    return text;
}

// Render message
function renderMessage(doc){
    const data = doc.data();
    const div = document.createElement('div');
    div.className = 'message';
    div.setAttribute('data-id', doc.id);

    const nameP = document.createElement('p');
    nameP.innerHTML = `<b>${data.name}:</b>`;
    div.appendChild(nameP);

    if(data.text){
        const textP = document.createElement('p');
        textP.innerHTML = parseMarkdown(data.text);
        div.appendChild(textP);
    }

    // dev-only delete button
    if(window.location.search.includes("dev=true")){
        const delBtn = document.createElement('span');
        delBtn.className = 'dev-delete';
        delBtn.textContent = "[x]";
        delBtn.onclick = ()=> db.collection('messages').doc(doc.id).delete();
        nameP.appendChild(delBtn);
    }

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// real-time listener
db.collection('messages').orderBy('timestamp').onSnapshot(snapshot=>{
    chatContainer.innerHTML='';
    snapshot.forEach(doc=>renderMessage(doc));
});

// send message
async function sendMessage(){
    const name = nameInput.value.trim() || "Anonymous";
    const text = textInput.value.trim();
    if(!text) return;

    if(text==="/clearchat" && window.location.search.includes("dev=true")){
        const snap = await db.collection('messages').get();
        snap.forEach(doc=>doc.ref.delete());
        textInput.value='';
        return;
    }

    await db.collection('messages').add({
        name,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    textInput.value='';
}

sendBtn.onclick = sendMessage;
textInput.addEventListener('keydown',e=>{ if(e.key==="Enter") sendMessage(); });

// expose dev commands to console
window.pangChatDev = {
    clearChat: async ()=> {
        const snap = await db.collection('messages').get();
        snap.forEach(doc=>doc.ref.delete());
        console.log("Chat cleared!");
    },
    deleteMessage: async (docId)=> {
        await db.collection('messages').doc(docId).delete();
        console.log("Deleted message:", docId);
    }
};
</script>
</body>
</html>
