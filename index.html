<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PangChat Room</title>
<style>
body { background:#111; color:white; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; padding:20px;}
#patchBanner { margin-bottom:10px; font-weight:bold; }
#versionWarning { color:#f55; margin-bottom:10px; display:none; }
#chatContainer { width:90%; max-width:600px; height:400px; overflow-y:auto; background:#222; padding:10px; border-radius:10px; margin-bottom:10px;}
.message { margin:5px 0; padding:5px; border-radius:5px; background:#444; }
.message p { margin:2px 0 0 0; }
.message a { color:#0af; text-decoration:underline; }
#inputRow { display:flex; width:90%; max-width:600px; }
#nameInput, #textInput { padding:8px; border-radius:5px; border:none; margin-right:5px; flex:1; }
#sendBtn { padding:8px 15px; border:none; border-radius:5px; background:#00f; color:#fff; cursor:pointer; }
.dev-delete { font-size:10px; color:red; cursor:pointer; margin-left:6px; }
</style>
</head>
<body>

<h2>PangChat Room</h2>
<div id="patchBanner">Current Patch: 1.3.0</div>
<div id="versionWarning">⚠ Your patch is outdated. Please update to send messages!</div>
<div id="chatContainer"></div>

<div id="inputRow">
<input id="nameInput" placeholder="Your name" />
<input id="textInput" placeholder="Type a message..." />
<button id="sendBtn">Send</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const PATCH_VERSION = "1.3.0";

const firebaseConfig = {
  apiKey: "AIzaSyBpDQlmOZHQrdRQF1mQPk_aPgxwb6gbheY",
  authDomain: "pangai.firebaseapp.com",
  projectId: "pangai",
  storageBucket: "pangai.firebasestorage.app",
  messagingSenderId: "456349287523",
  appId: "1:456349287523:web:e0a252e4b55f3dd294e456"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const chatContainer = document.getElementById('chatContainer');
const nameInput = document.getElementById('nameInput');
const textInput = document.getElementById('textInput');
const sendBtn = document.getElementById('sendBtn');
const versionWarning = document.getElementById('versionWarning');

let versionAllowed = false;

// Escape HTML + Markdown
function escapeHTML(str){
    return str.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
}
function parseMarkdown(text){
    text = escapeHTML(text);
    text = text.replace(/\*\*(.*?)\*\*/g,"<b>$1</b>");
    text = text.replace(/\*(.*?)\*/g,"<i>$1</i>");
    text = text.replace(/`(.*?)`/g,"<code>$1</code>");
    text = text.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank">$1</a>');
    return text;
}

// Render a message
function renderMessage(doc){
    const data = doc.data();
    const div = document.createElement('div');
    div.className = 'message';
    div.setAttribute('data-id', doc.id);

    const nameP = document.createElement('p');
    nameP.innerHTML = `<b>${escapeHTML(data.name)}:</b>`;
    div.appendChild(nameP);

    if(data.text){
        const textP = document.createElement('p');
        textP.innerHTML = parseMarkdown(data.text);
        div.appendChild(textP);
    }

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Check allowed versions
async function checkVersion() {
    try {
        const doc = await db.collection("config").doc("version").get();
        const allowed = doc.exists && Array.isArray(doc.data().allowedVersions) 
                        ? doc.data().allowedVersions 
                        : [];
        versionAllowed = allowed.includes(PATCH_VERSION);
        if(!versionAllowed){
            versionWarning.style.display = "block";
            textInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = "Disabled";
        } else {
            versionWarning.style.display = "none";
            textInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = "Send";
        }
    } catch(e){
        console.warn("Version check failed", e);
        versionAllowed = false;
        versionWarning.style.display = "block";
        textInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = "Disabled";
    }
}

checkVersion();

// Real-time listener
db.collection('messages').orderBy('timestamp').onSnapshot(snapshot=>{
    chatContainer.innerHTML='';
    snapshot.forEach(doc=>renderMessage(doc));
});

// Send message
async function sendMessage(){
    if(!versionAllowed) return;
    const name = nameInput.value.trim() || "Anonymous";
    const text = textInput.value.trim();
    if(!text) return;
    if(text.length>300) return alert("Message too long! Max 300 chars.");
    await db.collection('messages').add({
        name,
        text,
        clientVersion: PATCH_VERSION,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    textInput.value='';
}

sendBtn.onclick = sendMessage;
textInput.addEventListener('keydown', e=>{if(e.key==="Enter") sendMessage();});

// --- Dev Console Commands ---
window.pangChatDev = {
    clearChat: async function() {
        const pass = prompt("Enter dev passcode:");
        if(pass!=="YOUR_SECRET_DEV_PASS") return console.warn("Wrong passcode!");
        const snap = await db.collection('messages').get();
        snap.forEach(doc=>doc.ref.delete());
        console.log("✅ Chat cleared!");
    },
    deleteMessage: async function(docId) {
        const pass = prompt("Enter dev passcode:");
        if(pass!=="YOUR_SECRET_DEV_PASS") return console.warn("Wrong passcode!");
        if(!docId) return console.warn("Must provide a message ID!");
        await db.collection('messages').doc(docId).delete();
        console.log("✅ Deleted message:", docId);
    }
};
</script>
</body>
</html>
